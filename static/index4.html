<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceBot AI</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background: #f3f4f6;
        }
        .message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        .user {
            background: #2563eb;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }
        .bot {
            background: white;
            border-bottom-left-radius: 0;
            border: 1px solid #e5e7eb;
        }

        .chat-scroll {
            overflow-y: auto;
            height: calc(100vh - 160px);
            padding-right: 6px;
        }
    </style>
</head>

<body class="flex flex-col h-screen">

    <header class="bg-white shadow p-4 font-semibold text-xl">
        VoiceBot AI
    </header>

    <!-- CHAT CONTAINER -->
    <div id="chat" class="chat-scroll p-4"></div>

    <!-- INPUT AREA -->
    <div class="w-full bg-white shadow-md p-4 flex items-center gap-3">

        <!-- Mic button -->
        <button id="micBtn"
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-full text-xl">
            üéôÔ∏è
        </button>

        <!-- Text input -->
        <input id="textInput"
            placeholder="Type your message..."
            class="flex-1 border rounded-lg px-4 py-3 outline-none" />

        <!-- Send button -->
        <button id="sendBtn"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
            Send
        </button>
    </div>

    <script>
        const chat = document.getElementById("chat");
        const textInput = document.getElementById("textInput");
        const sendBtn = document.getElementById("sendBtn");
        const micBtn = document.getElementById("micBtn");

        let messages = [];
        let recorder;
        let chunks = [];

        const BASE_URL = "http://localhost:8000";

        // -----------------------------
        //  UI HELPERS
        // -----------------------------
        // function addUserMessage(msg) {
        //     let bubble = document.createElement("div");
        //     bubble.className = "message-bubble user";
        //     bubble.innerHTML = msg;
        //     chat.appendChild(bubble);
        //     chat.scrollTop = chat.scrollHeight;
        // }

        function addUserMessage(msg) {
            let bubble = document.createElement("div");
            bubble.className = "message-bubble user";
            bubble.textContent = msg;
            chat.appendChild(bubble);
            chat.scrollTop = chat.scrollHeight;
        }


        // function addBotMessage(msg, audioUrl=null) {
        //     let bubble = document.createElement("div");
        //     bubble.className = "message-bubble bot";

        //     let audioHTML = "";
        //     if (audioUrl) {
        //         audioHTML = `
        //             <audio controls class="mt-2">
        //                 <source src="${BASE_URL}${audioUrl}" type="audio/mpeg">
        //             </audio>
        //         `;
        //     }

        //     bubble.innerHTML = msg + audioHTML;
        //     chat.appendChild(bubble);
        //     chat.scrollTop = chat.scrollHeight;
        // }
            
        function addBotMessage(msg, audioUrl = null) {
            let bubble = document.createElement("div");
            bubble.className = "message-bubble bot";

            // Add text safely
            let textEl = document.createElement("div");
            textEl.textContent = msg;
            bubble.appendChild(textEl);

            // Add audio separately
            if (audioUrl) {
                let audio = document.createElement("audio");
                audio.controls = true;
                audio.src = BASE_URL + audioUrl;
                audio.className = "mt-2";
                bubble.appendChild(audio);
            }

            chat.appendChild(bubble);
            chat.scrollTop = chat.scrollHeight;
        }

        // -----------------------------
        //  SEND TEXT TO BACKEND
        // -----------------------------
        async function sendText() {
            let text = textInput.value.trim();
            if (!text) return;

            addUserMessage(text);

            messages.push({ role: "user", content: text });
            textInput.value = "";

            const res = await fetch(`${BASE_URL}/ask_question`, {
                method: "POST",
                headers: { "Content-Type": "application/json"},
                body: JSON.stringify({ question: text, messages })
            });

            const data = await res.json();
            messages = data.messages;

            addBotMessage(data.response, data.audio_url || null);
        }

        sendBtn.addEventListener("click", sendText);
        textInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") sendText();
        });

        // -----------------------------
        //  MIC RECORDING (WEBM)
        // -----------------------------
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                recorder = new MediaRecorder(stream);

                recorder.ondataavailable = e => chunks.push(e.data);

                // recorder.onstop = async () => {
                //     let blob = new Blob(chunks, { type: "audio/webm" });
                //     chunks = [];

                //     let form = new FormData();
                //     form.append("file", blob, "audio.webm");
                //     form.append("messages", JSON.stringify(messages));

                //     // addUserMessage("üé§ You spoke something...");

                //     const res = await fetch(`${BASE_URL}/process_audio`, {
                //         method: "POST",
                //         body: form
                //     });

                //     const data = await res.json();
                //     messages = data.messages;

                //     addBotMessage(data.response, data.audio_url || null);
                // };

                recorder.onstop = async () => {
                    let blob = new Blob(chunks, { type: "audio/webm" });
                    chunks = [];

                    let form = new FormData();
                    form.append("file", blob, "audio.webm");
                    form.append("messages", JSON.stringify(messages));

                    // ‚ùå REMOVE THIS
                    // addUserMessage("üé§ You spoke something...");

                    const res = await fetch(`${BASE_URL}/process_audio`, {
                        method: "POST",
                        body: form
                    });

                    const data = await res.json();
                    messages = data.messages;

                    // ‚úÖ SHOW ACTUAL USER TRANSCRIPT
                    addUserMessage(data.transcript);

                    // BOT RESPONSE + AUDIO
                    addBotMessage(data.response, data.audio_url || null);
                };

            });

        micBtn.addEventListener("click", () => {
            if (recorder.state === "inactive") {
                recorder.start();
                micBtn.innerText = "‚èπÔ∏è";
                micBtn.classList.remove("bg-red-500");
                micBtn.classList.add("bg-green-600");
            } else {
                recorder.stop();
                micBtn.innerText = "üéôÔ∏è";
                micBtn.classList.add("bg-red-500");
                micBtn.classList.remove("bg-green-600");
            }
        });

    </script>

</body>
</html>
