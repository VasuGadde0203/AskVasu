<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vasu AI ‚Äì Recruiter Assistant</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
      --bg-gradient-dark: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%);
      --bg-gradient-light: radial-gradient(circle at top, #e5e7eb 0, #d1d5db 40%, #9ca3af 100%);
      --glass-bg-dark: rgba(15, 23, 42, 0.85);
      --glass-bg-light: rgba(248, 250, 252, 0.88);
      --glass-border-dark: rgba(148, 163, 184, 0.4);
      --glass-border-light: rgba(148, 163, 184, 0.6);
      --text-dark: #e5e7eb;
      --text-light: #0f172a;
      --muted-dark: #9ca3af;
      --muted-light: #6b7280;
      --accent: #6366f1;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      min-height: 100vh;
      background: var(--bg-gradient-dark);
      color: var(--text-dark);
      display: flex;
      justify-content: center;
      padding: 0.75rem;
    }

    body[data-theme="light"] {
      background: var(--bg-gradient-light);
      color: var(--text-light);
    }

    .glass-shell {
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      border-radius: 1.5rem;
      border: 1px solid var(--glass-border-dark);
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.96),
        rgba(15, 23, 42, 0.9)
      );
      box-shadow:
        0 26px 60px rgba(15, 23, 42, 0.85),
        0 0 0 1px rgba(15, 23, 42, 0.8);
      max-width: 1280px;
      width: 100%;
    }

    body[data-theme="light"] .glass-shell {
      background: linear-gradient(
        135deg,
        rgba(248, 250, 252, 0.96),
        rgba(229, 231, 235, 0.96)
      );
      border-color: var(--glass-border-light);
      box-shadow:
        0 20px 40px rgba(148, 163, 184, 0.4),
        0 0 0 1px rgba(148, 163, 184, 0.4);
    }

    .sidebar-glass {
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.32), transparent 55%),
                  radial-gradient(circle at bottom, rgba(17, 24, 39, 0.85), rgba(15, 23, 42, 0.96));
      border-right: 1px solid rgba(51, 65, 85, 0.8);
    }

    body[data-theme="light"] .sidebar-glass {
      background: radial-gradient(circle at top left, rgba(96, 165, 250, 0.25), transparent 55%),
                  linear-gradient(180deg, rgba(243, 244, 246, 0.96), rgba(229, 231, 235, 0.98));
      border-right-color: rgba(148, 163, 184, 0.8);
    }

    .chat-glass {
      background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.16), transparent 55%),
                  radial-gradient(circle at bottom, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
    }

    body[data-theme="light"] .chat-glass {
      background: radial-gradient(circle at top right, rgba(165, 243, 252, 0.26), transparent 55%),
                  linear-gradient(180deg, rgba(249, 250, 251, 0.96), rgba(229, 231, 235, 0.98));
    }

    .message-bubble {
      max-width: 90%;
      padding: 0.9rem 1.1rem;
      border-radius: 1rem;
      margin-bottom: 0.75rem;
      word-wrap: break-word;
      font-size: 0.92rem;
      line-height: 1.45;
    }

    @media (min-width: 768px) {
      .message-bubble {
        max-width: 72%;
        font-size: 0.98rem;
      }
    }

    .message-user {
      margin-left: auto;
      border-bottom-right-radius: 0.25rem;
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: #f9fafb;
      box-shadow:
        0 12px 30px rgba(79, 70, 229, 0.6),
        0 0 0 1px rgba(191, 219, 254, 0.3);
    }

    .message-bot {
      margin-right: auto;
      border-bottom-left-radius: 0.25rem;
      background: rgba(15, 23, 42, 0.97);
      border: 1px solid rgba(51, 65, 85, 0.9);
      color: #e5e7eb;
      box-shadow:
        0 16px 40px rgba(15, 23, 42, 0.9);
    }

    body[data-theme="light"] .message-bot {
      background: rgba(249, 250, 251, 0.96);
      border-color: rgba(209, 213, 219, 0.9);
      color: #111827;
      box-shadow:
        0 12px 30px rgba(148, 163, 184, 0.45);
    }

    .markdown-body p {
      margin: 0.25rem 0;
    }

    .markdown-body ul {
      list-style-type: disc;
      padding-left: 1.2rem;
      margin: 0.35rem 0 0.5rem;
    }

    .markdown-body ol {
      list-style-type: decimal;
      padding-left: 1.25rem;
      margin: 0.35rem 0 0.5rem;
    }

    .markdown-body li {
      margin: 0.1rem 0;
    }

    .markdown-body strong {
      font-weight: 600;
    }

    .markdown-body h3,
    .markdown-body h4 {
      font-weight: 600;
      margin-top: 0.4rem;
      margin-bottom: 0.2rem;
      font-size: 0.98rem;
    }

    .markdown-body code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
      background: rgba(15, 23, 42, 0.8);
      padding: 0.1rem 0.3rem;
      border-radius: 0.25rem;
    }

    body[data-theme="light"] .markdown-body code {
      background: rgba(209, 213, 219, 0.7);
    }

    .scroll-smooth {
      scroll-behavior: smooth;
    }

    .questions-scroll {
      scrollbar-width: thin;
    }

    .questions-scroll::-webkit-scrollbar {
      height: 4px;
      width: 4px;
    }

    .questions-scroll::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.7);
      border-radius: 999px;
    }

    .chat-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .chat-scroll::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.6);
      border-radius: 999px;
    }

    .shadow-input-dark {
      box-shadow:
        0 10px 30px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(30, 64, 175, 0.4);
    }

    body[data-theme="light"] .shadow-input-dark {
      box-shadow:
        0 12px 30px rgba(148, 163, 184, 0.7),
        0 0 0 1px rgba(129, 140, 248, 0.7);
    }

    .mic-pulse {
      box-shadow:
        0 0 0 0 rgba(239, 68, 68, 0.7);
      animation: pulse 1.4s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.75);
      }
      70% {
        transform: scale(1.06);
        box-shadow: 0 0 0 16px rgba(239, 68, 68, 0);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }
  </style>
</head>

<body class="scroll-smooth" data-theme="dark">
  <div class="glass-shell flex flex-col md:flex-row overflow-hidden w-full h-[calc(100vh-1.5rem)] md:h-[92vh]">
    <!-- Sidebar (desktop) -->
    <aside class="sidebar-glass hidden md:flex w-72 flex-col p-5">
      <div class="mb-6">
        <h2 class="text-lg font-semibold tracking-tight">Ask Vasu</h2>
        <p class="mt-1 text-xs text-slate-400">
          Most asked recruiter questions:
        </p>
      </div>

      <div id="sidebar-questions" class="space-y-2 overflow-y-auto pr-1 questions-scroll text-sm">
        <!-- Buttons inserted by JS -->
      </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col chat-glass">
      <!-- Header -->
      <header class="flex items-center justify-between px-4 md:px-6 py-4 border-b border-slate-800/70">
        <div>
          <h1 class="text-base md:text-lg font-semibold tracking-tight">
            Vasu AI ‚Äì Recruiter Assistant
          </h1>
          <p class="text-xs md:text-sm text-slate-400 mt-1 max-w-xl">
            Ask about Vasu‚Äôs experience, projects, and how he fits your role.
          </p>
        </div>

        <button id="themeToggle"
          class="inline-flex items-center gap-2 rounded-full border border-slate-700/80 px-3 py-1.5 text-xs md:text-sm text-slate-200 hover:bg-slate-800/60 transition">
          <span id="themeIcon">üåô</span>
          <span id="themeLabel">Light</span>
        </button>
      </header>

      <!-- Mobile question chips -->
      <section class="md:hidden px-3 py-2 border-b border-slate-800/70">
        <div id="mobile-questions"
             class="flex gap-2 overflow-x-auto questions-scroll pb-1 text-xs">
          <!-- Chips inserted by JS -->
        </div>
      </section>

      <!-- Chat messages -->
      <section id="chat"
        class="flex-1 overflow-y-auto px-3 md:px-6 py-4 md:py-5 chat-scroll">
        <!-- Messages inserted by JS -->
      </section>

      <!-- Input Area -->
      <footer class="px-3 md:px-6 pb-4 md:pb-5 pt-2 border-t border-slate-800/80">
        <div
          class="relative flex items-center gap-2 md:gap-3 bg-slate-900/80 body-light:bg-slate-100/90 rounded-2xl px-3 py-2 md:px-4 md:py-2.5 shadow-input-dark">
          <!-- Mic button -->
          <button id="micBtn"
            class="flex h-10 w-10 md:h-11 md:w-11 items-center justify-center rounded-full bg-red-500 hover:bg-red-600 text-white text-xl transition">
            üéôÔ∏è
          </button>

          <!-- Text input -->
          <input id="textInput" type="text" autocomplete="off"
            placeholder="Type your question..."
            class="flex-1 bg-transparent border-none outline-none text-sm md:text-base placeholder:text-slate-500 text-slate-100" />

          <!-- Send button -->
          <button id="sendBtn"
            class="inline-flex items-center justify-center rounded-xl bg-indigo-500 hover:bg-indigo-600 text-white text-sm md:text-base font-medium px-4 md:px-5 py-2 disabled:opacity-60 disabled:cursor-not-allowed transition">
            Send
          </button>
        </div>

        <p class="mt-1.5 text-[0.65rem] md:text-[0.7rem] text-slate-500 text-right">
          Tip: You can either type or hold the mic, then release to send a voice question.
        </p>
      </footer>
    </main>
  </div>

  <script>
    const chatEl = document.getElementById("chat");
    const textInput = document.getElementById("textInput");
    const sendBtn = document.getElementById("sendBtn");
    const micBtn = document.getElementById("micBtn");
    const themeToggle = document.getElementById("themeToggle");
    const themeIcon = document.getElementById("themeIcon");
    const themeLabel = document.getElementById("themeLabel");
    const sidebarQuestions = document.getElementById("sidebar-questions");
    const mobileQuestions = document.getElementById("mobile-questions");

    const BASE_URL = window.location.origin; // works for localhost:8000 & deployments

    let messages = [];
    let recorder;
    let chunks = [];
    let isRecording = false;
    let isSending = false;

    const FAQs = [
      "Tell me about yourself.",
      "Walk me through your experience at JHS Associates.",
      "Explain your AI-powered recruitment system project.",
      "What are your strongest skills?",
      "Why should we hire you?",
      "Explain your WhatsApp Chat Analyzer project.",
      "Explain your CryptoLab project.",
      "Explain your Personal Research Assistant project.",
      "Explain your GitaChatBot project.",
      "Explain your AI-powered Document Analyzer project.",
      "Explain your Machine Learning internship experience."
    ];

    // -------------------------
    // Theme handling
    // -------------------------
    function applyTheme(theme) {
      document.body.setAttribute("data-theme", theme);
      if (theme === "dark") {
        themeIcon.textContent = "üåô";
        themeLabel.textContent = "Light";
      } else {
        themeIcon.textContent = "‚òÄÔ∏è";
        themeLabel.textContent = "Dark";
      }
      localStorage.setItem("vasu-theme", theme);
    }

    const storedTheme = localStorage.getItem("vasu-theme") || "dark";
    applyTheme(storedTheme);

    themeToggle.addEventListener("click", () => {
      const next = document.body.getAttribute("data-theme") === "dark" ? "light" : "dark";
      applyTheme(next);
    });

    // -------------------------
    // Helper: scroll chat
    // -------------------------
    function scrollChatToBottom() {
      requestAnimationFrame(() => {
        chatEl.scrollTop = chatEl.scrollHeight;
      });
    }

    // -------------------------
    // Renderers
    // -------------------------
    function addUserMessage(text, opts = {}) {
      const bubble = document.createElement("div");
      bubble.className = "message-bubble message-user";
      if (opts.pending) {
        bubble.classList.add("opacity-70", "italic");
      }
      bubble.textContent = text;
      chatEl.appendChild(bubble);
      scrollChatToBottom();
      return bubble;
    }

    function addBotMessage(text, audioUrl = null) {
      const bubble = document.createElement("div");
      bubble.className = "message-bubble message-bot";

      const content = document.createElement("div");
      content.className = "markdown-body text-sm md:text-[0.95rem]";
      try {
        const html = marked.parse(text || "");
        content.innerHTML = html;
      } catch (err) {
        console.error("Markdown parse error:", err);
        content.textContent = text || "";
      }

      bubble.appendChild(content);

      if (audioUrl) {
        const audioWrapper = document.createElement("div");
        audioWrapper.className = "mt-3";
        const audioEl = document.createElement("audio");
        audioEl.controls = true;
        audioEl.src = BASE_URL + audioUrl;
        audioEl.className = "w-full max-w-xs";
        audioWrapper.appendChild(audioEl);
        bubble.appendChild(audioWrapper);
      }

      chatEl.appendChild(bubble);
      scrollChatToBottom();
    }

    function addSystemWelcome() {
      const welcome = `Hi, I'm Vasu's AI interview assistant.  
You can ask me about his experience, projects, skills, and why he might fit your role.  
Use the sample questions on the left or ask your own.`;
      addBotMessage(welcome, null);
    }

    // -------------------------
    // FAQ buttons
    // -------------------------
    function buildQuestionButtons() {
      FAQs.forEach(q => {
        // Sidebar (desktop)
        const btnSide = document.createElement("button");
        btnSide.className =
          "w-full text-left text-xs md:text-sm rounded-xl px-3 py-2 bg-slate-900/70 hover:bg-slate-800/80 text-slate-100 border border-slate-700/70 transition";
        btnSide.textContent = q;
        btnSide.addEventListener("click", () => handleTextQuestion(q, true));
        sidebarQuestions.appendChild(btnSide);

        // Mobile chips
        const chip = document.createElement("button");
        chip.className =
          "shrink-0 rounded-full border border-slate-600/70 bg-slate-900/80 px-3 py-1.5 text-[0.7rem] text-slate-100 hover:bg-slate-800/80";
        chip.textContent = q;
        chip.addEventListener("click", () => handleTextQuestion(q, true));
        mobileQuestions.appendChild(chip);
      });
    }

    // -------------------------
    // Send text question
    // -------------------------
    async function handleTextQuestion(text, fromFAQ = false) {
      if (!text || isSending) return;

      isSending = true;
      sendBtn.disabled = true;

      const userBubble = addUserMessage(text);

      const payload = {
        question: text,
        messages: messages
      };

      try {
        const res = await fetch(`${BASE_URL}/ask_question`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();
        messages = data.messages || [];
        addBotMessage(data.response, data.audio_url || null);

      } catch (err) {
        console.error("Text question error:", err);
        addBotMessage("Sorry, something went wrong while answering that. Please try again.");
      } finally {
        isSending = false;
        sendBtn.disabled = false;
        scrollChatToBottom();
      }
    }

    async function sendText() {
      const text = textInput.value.trim();
      if (!text) return;
      textInput.value = "";
      await handleTextQuestion(text, false);
    }

    sendBtn.addEventListener("click", sendText);
    textInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendText();
      }
    });

    // -------------------------
    // Voice recording
    // -------------------------
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        recorder = new MediaRecorder(stream);

        recorder.ondataavailable = (e) => {
          if (e.data.size > 0) {
            chunks.push(e.data);
          }
        };

        recorder.onstop = async () => {
          if (!chunks.length) return;

          const blob = new Blob(chunks, { type: "audio/webm" });
          chunks = [];

          // show pending user bubble
          const pendingBubble = addUserMessage("Transcribing...", { pending: true });

          const form = new FormData();
          form.append("file", blob, "audio.webm");
          form.append("messages", JSON.stringify(messages));

          try {
            const res = await fetch(`${BASE_URL}/process_audio`, {
              method: "POST",
              body: form
            });

            if (!res.ok) {
              throw new Error(`HTTP ${res.status}`);
            }

            const data = await res.json();
            messages = data.messages || [];

            // update bubble with real transcript
            pendingBubble.textContent = data.transcript || "[Unclear audio]";
            pendingBubble.classList.remove("opacity-70", "italic");

            // add answer
            addBotMessage(data.response, data.audio_url || null);
          } catch (err) {
            console.error("Audio question error:", err);
            pendingBubble.textContent = "Sorry, I couldn't process that audio. Please try again.";
            pendingBubble.classList.remove("opacity-70", "italic");
          } finally {
            micBtn.classList.remove("mic-pulse");
            micBtn.textContent = "üéôÔ∏è";
            isRecording = false;
          }
        };
      })
      .catch(err => {
        console.error("Mic permission error:", err);
        micBtn.disabled = true;
        micBtn.title = "Microphone permission denied";
      });

    micBtn.addEventListener("click", () => {
      if (!recorder) return;
      if (!isRecording) {
        chunks = [];
        recorder.start();
        isRecording = true;
        micBtn.classList.add("mic-pulse");
        micBtn.textContent = "‚èπÔ∏è";
      } else {
        recorder.stop();
      }
    });

    // -------------------------
    // Init
    // -------------------------
    buildQuestionButtons();
    addSystemWelcome();
  </script>
</body>
</html>
